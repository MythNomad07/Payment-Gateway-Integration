<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Stripe Checkout Test</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; }
    #card-element { padding: 12px; border: 1px solid #ccc; border-radius: 6px; margin: 12px 0; }
    button { padding: 10px 20px; background: #6772e5; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    button:disabled { background: #bbb; cursor: not-allowed; }
    pre { background:#f6f8fa; padding:12px; border-radius:6px; overflow:auto; }
    .muted { color:#666; font-size:0.9rem; }
  </style>
</head>
<body>
  <h2>Stripe Payment Demo</h2>

  <!-- Stripe element -->
  <div id="card-element"></div>

  <button id="payBtn">Pay Now</button>
  <p id="message" class="muted"></p>

  <!-- Status & txn area (hidden until used) -->
  <div id="status-area" style="display:none; margin-top: 20px;">
    <p id="success-msg" style="color:green; font-weight:bold;"></p>
    <p><strong>Txn ID:</strong> <span id="txn-id" style="word-break:break-all"></span></p>

    <div style="margin-top:10px;">
      <input type="text" id="status-txn-input" placeholder="Enter Txn ID" style="width:300px;">
      <button id="check-status-btn">Check Payment Status</button>
      <button id="copy-txn-btn">Copy Txn ID</button>
    </div>

    <h4 style="margin-top:12px;">Status result</h4>
    <pre id="status-result">No check performed yet.</pre>
  </div>

  <script>
    // Replace with your publishable key
    const stripe = Stripe("pk_test_51S9o1aIvIjWabNzf4j1NShDzZRBG2JTB8HPGVwAV9AB0E2ioN2z1FmX6fjShGsc5q3AmYPQN9BoExhFZaN8xoQ2P00RlXLlmwJ");

    const elements = stripe.elements();
    const cardElement = elements.create("card");
    cardElement.mount("#card-element");

    const payBtn = document.getElementById("payBtn");
    const msg = document.getElementById("message");
    const statusArea = document.getElementById("status-area");
    const successMsg = document.getElementById("success-msg");
    const txnIdSpan = document.getElementById("txn-id");
    const statusResult = document.getElementById("status-result");
    const checkBtn = document.getElementById("check-status-btn");
    const copyBtn = document.getElementById("copy-txn-btn");
    const statusInput = document.getElementById("status-txn-input");

    function showStatusJson(obj) {
      statusResult.textContent = JSON.stringify(obj, null, 2);
    }

    copyBtn.addEventListener("click", () => {
      const t = txnIdSpan.textContent.trim();
      if (!t) return alert("No Txn ID to copy.");
      navigator.clipboard?.writeText(t).then(() => {
        alert("Txn ID copied to clipboard.");
      }).catch(()=>{ alert("Copy failed — select and copy manually."); });
    });

    checkBtn.addEventListener("click", async () => {
      const txn = (statusInput.value || txnIdSpan.textContent || "").trim();
      if (!txn) {
        return alert("Please provide a Txn ID (either paste it or use the current one).");
      }
      statusResult.textContent = "Checking...";
      try {
        const res = await fetch(`/api/payment/status/${txn}`);
        if (!res.ok) {
          const txt = await res.text();
          statusResult.textContent = `Error: ${res.status} ${txt}`;
          return;
        }
        const json = await res.json();
        showStatusJson(json);
      } catch (err) {
        statusResult.textContent = `Network error: ${err.message}`;
      }
    });

    payBtn.addEventListener("click", async () => {
      payBtn.disabled = true;
      msg.textContent = "Processing...";

      try {
        // ✅ Notice: no "http://localhost:3000" — works on both local & Render
        const res = await fetch("/api/payment/create-payment-intent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount: 5000, currency: "usd" })
        });

        if (!res.ok) {
          const errText = await res.text();
          throw new Error(errText || `Server returned ${res.status}`);
        }

        const data = await res.json();
        console.log("Backend response:", data);

        txnIdSpan.textContent = data.txn_id;
        statusArea.style.display = "block";
        successMsg.textContent = "";
        statusResult.textContent = "Waiting for payment confirmation...";

        const { error, paymentIntent } = await stripe.confirmCardPayment(data.clientSecret, {
          payment_method: { card: cardElement }
        });

        if (error) {
          msg.textContent = `❌ Payment failed: ${error.message || "Unknown error"}`;
          statusResult.textContent = `Payment failed: ${error.message || "Unknown error"}`;
          payBtn.disabled = false;
          return;
        }

        if (paymentIntent && paymentIntent.status === "succeeded") {
          msg.textContent = "";
          successMsg.innerHTML = "✅ Payment successful!";
          txnIdSpan.textContent = data.txn_id;
          statusArea.style.display = "block";
          try {
            const r2 = await fetch(`/api/payment/status/${data.txn_id}`);
            if (r2.ok) {
              const j2 = await r2.json();
              showStatusJson(j2);
            } else {
              statusResult.textContent = "Payment created — waiting for webhook update.";
            }
          } catch (err) {
            statusResult.textContent = "Could not fetch status: " + err.message;
          }
        } else {
          msg.textContent = "Payment processed but not succeeded: " + (paymentIntent?.status || "unknown");
        }
      } catch (err) {
        console.error(err);
        msg.textContent = `❌ Error: ${err.message || "unknown"}`;
      } finally {
        payBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
