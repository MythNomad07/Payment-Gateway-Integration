<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Stripe Checkout Demo</title>
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; }
    #card-element { padding: 12px; border: 1px solid #ccc; border-radius: 6px; margin: 12px 0; }
    button { padding: 10px 20px; background: #6772e5; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    button:disabled { background: #bbb; cursor: not-allowed; }
    pre { background:#f6f8fa; padding:12px; border-radius:6px; overflow:auto; }
    .muted { color:#666; font-size:0.9rem; }
  </style>
</head>
<body>
  <h2>Stripe Payment Demo</h2>

  <!-- Stripe element -->
  <div id="card-element"></div>

  <button id="payBtn">Pay Now</button>
  <p id="message" class="muted"></p>

  <!-- Status & txn area -->
  <div id="status-area" style="display:none; margin-top: 20px;">
    <p id="success-msg" style="color:green; font-weight:bold;"></p>
    <p><strong>Txn ID:</strong> <span id="txn-id" style="word-break:break-all"></span></p>
    <p><strong>PaymentIntent ID:</strong> <span id="pi-id" style="word-break:break-all"></span></p>

    <div style="margin-top:10px;">
      <button id="check-status-btn">Check Payment Status</button>
      <button id="copy-txn-btn">Copy Txn ID</button>
    </div>

    <h4 style="margin-top:12px;">Status result</h4>
    <pre id="status-result">Waiting for status check...</pre>
  </div>

  <script>
    const stripe = Stripe("pk_test_51S9o1aIvIjWabNzf4j1NShDzZRBG2JTB8HPGVwAV9AB0E2ioN2z1FmX6fjShGsc5q3AmYPQN9BoExhFZaN8xoQ2P00RlXLlmwJ");

    const elements = stripe.elements();
    const cardElement = elements.create("card");
    cardElement.mount("#card-element");

    const payBtn = document.getElementById("payBtn");
    const msg = document.getElementById("message");
    const statusArea = document.getElementById("status-area");
    const successMsg = document.getElementById("success-msg");
    const txnIdSpan = document.getElementById("txn-id");
    const piIdSpan = document.getElementById("pi-id");
    const statusResult = document.getElementById("status-result");
    const checkBtn = document.getElementById("check-status-btn");
    const copyBtn = document.getElementById("copy-txn-btn");

    let currentTxnId = "";
    let currentPiId = "";

    // Copy txn id
    copyBtn.addEventListener("click", () => {
      if (!currentTxnId) return alert("No Txn ID to copy.");
      navigator.clipboard?.writeText(currentTxnId).then(() => {
        alert("Txn ID copied to clipboard.");
      }).catch(()=>{ alert("Copy failed — select and copy manually."); });
    });

    // Check status button
    checkBtn.addEventListener("click", async () => {
      if (!currentTxnId) return alert("No Txn ID available.");
      statusResult.textContent = "Checking...";
      try {
        const res = await fetch(`/api/payment/status/${currentTxnId}`);
        if (!res.ok) {
          statusResult.textContent = `Error: ${res.status} ${await res.text()}`;
          return;
        }
        const json = await res.json();
        statusResult.textContent = JSON.stringify(json, null, 2);
      } catch (err) {
        statusResult.textContent = `Network error: ${err.message}`;
      }
    });

    // Pay button
    payBtn.addEventListener("click", async () => {
      payBtn.disabled = true;
      msg.textContent = "Processing...";

      try {
        const res = await fetch("/api/payment/create-payment-intent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount: 5000, currency: "usd" })
        });

        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();

        currentTxnId = data.txn_id;
        currentPiId = data.payment_intent_id;

        txnIdSpan.textContent = currentTxnId;
        piIdSpan.textContent = currentPiId;
        statusArea.style.display = "block";

        const { error, paymentIntent } = await stripe.confirmCardPayment(data.clientSecret, {
          payment_method: { card: cardElement }
        });

        if (error) {
          msg.textContent = `❌ Payment failed: ${error.message}`;
          statusResult.textContent = `Payment failed: ${error.message}`;
          return;
        }

        if (paymentIntent && paymentIntent.status === "succeeded") {
          msg.textContent = "";
          successMsg.textContent = "✅ Payment successful!";
          // Fetch latest status from DB
          checkBtn.click();
        } else {
          msg.textContent = `Payment processed but not succeeded: ${paymentIntent?.status}`;
        }
      } catch (err) {
        msg.textContent = `❌ Error: ${err.message}`;
      } finally {
        payBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
